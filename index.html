<!DOCTYPE html>
<html lang="en-us">
<base href="https://cdn.jsdelivr.net/gh/bubbls/UGS-Assets@354e3c6939a08e472482653567d566ba3a2aa527/half%20life/">
<head>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="MobileOptimized" content="2000">
	<meta name="HandheldFriendly" content="true">
	<title>IXL | Math, Language Arts, Science, Social Studies, and Spanish</title>
	
	<!-- Google Fonts -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&display=swap" rel="stylesheet">
	
	<style>
		/* ===== CSS RESET & BASE ===== */
		*, *::before, *::after {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		:root {
			--background: hsl(0 0% 4%);
			--foreground: hsl(0 0% 96%);
			--card: hsl(0 0% 8%);
			--card-foreground: hsl(0 0% 96%);
			--primary-hue: 36;
			--accent-hue: 180;
			--primary: hsl(var(--primary-hue) 100% 50%);
			--primary-dark: hsl(var(--primary-hue) 100% 35%);
			--accent: hsl(var(--accent-hue) 100% 50%);
			--secondary: hsl(0 0% 14%);
			--muted: hsl(0 0% 60%);
			--border: hsl(0 0% 20%);
			--radius: 0.75rem;
		}

		body {
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
			background-color: var(--background);
			color: var(--foreground);
			overflow-x: hidden;
			min-height: 100vh;
			line-height: 1.6;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}

		h1, h2, h3, h4, h5, h6 {
			font-family: 'Orbitron', sans-serif;
		}

		/* ===== RAINBOW SPIRAL GRID CANVAS ===== */
		#spiralCanvas {
			position: fixed;
			inset: 0;
			pointer-events: none;
			opacity: 0.6;
			z-index: 0;
		}

		/* ===== CONSTELLATION CANVAS ===== */
		#constellationCanvas {
			position: fixed;
			inset: 0;
			pointer-events: none;
			opacity: 0.7;
			z-index: 1;
		}

		/* ===== COLOR PICKER ===== */
		.color-picker {
			position: fixed;
			top: 1rem;
			right: 1rem;
			z-index: 100;
		}

		.color-picker-btn {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			background: var(--card);
			border: 2px solid var(--primary);
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.3s;
			box-shadow: 0 0 15px hsla(var(--primary-hue), 100%, 50%, 0.3);
		}

		.color-picker-btn:hover {
			transform: scale(1.1);
			box-shadow: 0 0 25px hsla(var(--primary-hue), 100%, 50%, 0.5);
		}

		.color-picker-btn svg {
			width: 20px;
			height: 20px;
			fill: var(--primary);
		}

		.color-picker-popup {
			display: none;
			position: absolute;
			top: 50px;
			right: 0;
			background: var(--card);
			border: 2px solid var(--primary);
			border-radius: var(--radius);
			padding: 1rem;
			min-width: 250px;
			box-shadow: 0 0 30px hsla(var(--primary-hue), 100%, 50%, 0.3);
		}

		.color-picker-popup.visible {
			display: block;
		}

		.color-picker-section {
			margin-bottom: 1rem;
		}

		.color-picker-section:last-child {
			margin-bottom: 0;
		}

		.color-picker-label {
			font-size: 0.75rem;
			color: var(--primary);
			margin-bottom: 0.5rem;
			display: block;
		}

		.color-presets {
			display: flex;
			gap: 0.5rem;
			flex-wrap: wrap;
			margin-bottom: 0.5rem;
		}

		.color-preset {
			width: 28px;
			height: 28px;
			border-radius: 50%;
			border: 2px solid transparent;
			cursor: pointer;
			transition: all 0.2s;
		}

		.color-preset:hover {
			transform: scale(1.15);
		}

		.color-preset.active {
			border-color: white;
		}

		.color-slider {
			width: 100%;
			height: 8px;
			-webkit-appearance: none;
			appearance: none;
			border-radius: 4px;
			background: linear-gradient(to right, 
				hsl(0, 100%, 50%), 
				hsl(60, 100%, 50%), 
				hsl(120, 100%, 50%), 
				hsl(180, 100%, 50%), 
				hsl(240, 100%, 50%), 
				hsl(300, 100%, 50%), 
				hsl(360, 100%, 50%)
			);
			cursor: pointer;
		}

		.color-slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			width: 16px;
			height: 16px;
			border-radius: 50%;
			background: white;
			border: 2px solid var(--background);
			cursor: pointer;
			box-shadow: 0 0 5px rgba(0,0,0,0.5);
		}

		.color-preview {
			display: flex;
			gap: 0.5rem;
			margin-top: 1rem;
		}

		.color-preview-box {
			flex: 1;
			height: 30px;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 0.65rem;
			font-weight: 600;
		}

		/* ===== MAIN CONTAINER ===== */
		.container {
			position: relative;
			z-index: 10;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			min-height: 100vh;
			padding: 2rem 1rem;
		}

		/* ===== TITLE SECTION ===== */
		.title-section {
			text-align: center;
			margin-bottom: 2.5rem;
			animation: float 6s ease-in-out infinite;
		}

		@keyframes float {
			0%, 100% { transform: translateY(0); }
			50% { transform: translateY(-10px); }
		}

		.title {
			font-size: clamp(2rem, 8vw, 3.5rem);
			font-weight: 700;
			background: linear-gradient(90deg, 
				hsl(0, 100%, 70%), 
				hsl(60, 100%, 70%), 
				hsl(120, 100%, 70%), 
				hsl(180, 100%, 70%), 
				hsl(240, 100%, 70%), 
				hsl(300, 100%, 70%), 
				hsl(360, 100%, 70%)
			);
			background-size: 200% auto;
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
			animation: rainbow-shimmer 3s linear infinite;
			letter-spacing: 0.1em;
			margin-bottom: 0.5rem;
		}

		@keyframes rainbow-shimmer {
			0% { background-position: 0% center; }
			100% { background-position: 200% center; }
		}

		.subtitle {
			font-size: clamp(1rem, 3vw, 1.25rem);
			color: hsla(0, 0%, 96%, 0.8);
			font-weight: 300;
			letter-spacing: 0.05em;
			animation: glow-pulse 2s ease-in-out infinite alternate;
		}

		@keyframes glow-pulse {
			from {
				text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
			}
			to {
				text-shadow: 0 0 20px currentColor, 0 0 40px currentColor, 0 0 60px currentColor;
			}
		}

		/* ===== SETTINGS CARD ===== */
		.settings-card {
			position: relative;
			width: 100%;
			max-width: 500px;
			background: linear-gradient(135deg, hsla(0, 0%, 8%, 0.9), hsla(0, 0%, 8%, 0.7));
			backdrop-filter: blur(20px);
			border: 2px solid transparent;
			border-radius: var(--radius);
			padding: 2rem;
			animation: rainbow-border 4s linear infinite;
			background-size: 100% 100%, 300% 300%;
			box-shadow: 0 8px 32px hsla(0, 0%, 0%, 0.3), inset 0 1px 0 hsla(255, 255%, 255%, 0.1);
			transition: transform 0.3s ease, box-shadow 0.3s ease;
			overflow: hidden;
		}

		.settings-card::before {
			content: '';
			position: absolute;
			inset: 0;
			background: linear-gradient(var(--card), var(--card)) padding-box,
						linear-gradient(135deg, 
							hsl(0, 100%, 50%), 
							hsl(60, 100%, 50%), 
							hsl(120, 100%, 50%), 
							hsl(180, 100%, 50%), 
							hsl(240, 100%, 50%), 
							hsl(300, 100%, 50%)
						) border-box;
			border: 2px solid transparent;
			border-radius: var(--radius);
			animation: rainbow-border 4s linear infinite;
			background-size: 100% 100%, 300% 300%;
			pointer-events: none;
		}

		/* Scanner line effect */
		.settings-card::after {
			content: '';
			position: absolute;
			top: 0;
			left: -100%;
			width: 50%;
			height: 100%;
			background: linear-gradient(90deg, transparent, hsla(180, 100%, 50%, 0.1), hsla(180, 100%, 70%, 0.2), hsla(180, 100%, 50%, 0.1), transparent);
			animation: scanner-sweep 4s ease-in-out infinite;
			pointer-events: none;
		}

		@keyframes scanner-sweep {
			0% { left: -50%; }
			100% { left: 150%; }
		}

		.settings-card:hover {
			transform: translateY(-4px);
			box-shadow: 0 12px 40px hsla(0, 0%, 0%, 0.4), 0 0 30px hsla(var(--primary-hue), 100%, 50%, 0.2);
		}

		@keyframes rainbow-border {
			0% { background-position: 0 0, 0% 50%; }
			50% { background-position: 0 0, 100% 50%; }
			100% { background-position: 0 0, 0% 50%; }
		}

		/* ===== FORM ELEMENTS ===== */
		.form-section {
			margin-bottom: 1.5rem;
			position: relative;
			z-index: 1;
		}

		.form-label {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			font-size: 0.875rem;
			font-weight: 500;
			color: var(--primary);
			text-shadow: 0 0 10px hsla(var(--primary-hue), 100%, 50%, 0.3);
			margin-bottom: 0.25rem;
			letter-spacing: 0.05em;
		}

		.form-label svg {
			width: 16px;
			height: 16px;
			stroke: var(--primary);
			stroke-width: 2;
			fill: none;
		}

		.form-hint {
			font-size: 0.75rem;
			color: var(--muted);
			margin-bottom: 1rem;
			margin-left: 1.5rem;
		}

		/* Radio Group */
		.radio-group {
			display: flex;
			flex-direction: column;
			gap: 0.75rem;
		}

		.radio-item {
			display: flex;
			align-items: center;
			gap: 0.75rem;
			cursor: pointer;
			transition: color 0.2s;
		}

		.radio-item:hover {
			color: var(--primary);
		}

		.radio-item:hover svg {
			stroke: var(--primary);
		}

		.radio-item svg {
			width: 16px;
			height: 16px;
			stroke: var(--muted);
			stroke-width: 2;
			fill: none;
			transition: stroke 0.2s;
		}

		.radio-item input[type="radio"] {
			appearance: none;
			-webkit-appearance: none;
			width: 18px;
			height: 18px;
			border: 2px solid var(--primary);
			border-radius: 50%;
			background: transparent;
			cursor: pointer;
			position: relative;
			transition: all 0.2s;
		}

		.radio-item input[type="radio"]:checked {
			background: var(--primary);
			box-shadow: 0 0 10px var(--primary);
		}

		.radio-item input[type="radio"]:checked::after {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 6px;
			height: 6px;
			background: var(--background);
			border-radius: 50%;
		}

		/* Text Input */
		.text-input {
			width: 100%;
			padding: 0.75rem 1rem;
			background: hsla(0, 0%, 14%, 0.5);
			border: 2px solid var(--border);
			border-radius: calc(var(--radius) - 4px);
			color: var(--foreground);
			font-family: 'Lucida Console', Monaco, monospace;
			font-size: 0.85rem;
			transition: all 0.3s;
		}

		.text-input:focus {
			outline: none;
			border-color: var(--primary);
			box-shadow: 0 0 15px hsla(var(--primary-hue), 100%, 50%, 0.3);
		}

		/* Separator */
		.separator {
			height: 1px;
			background: linear-gradient(90deg, transparent, var(--border), transparent);
			margin: 1.5rem 0;
			position: relative;
			z-index: 1;
		}
			-webkit-appearance: none;
			width: 18px;
			height: 18px;
			border: 2px solid var(--primary);
			border-radius: 50%;
			background: transparent;
			cursor: pointer;
			position: relative;
			transition: all 0.2s;
		}

		.radio-item input[type="radio"]:checked {
			background: var(--primary);
			box-shadow: 0 0 10px var(--primary);
		}

		.radio-item input[type="radio"]:checked::after {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 6px;
			height: 6px;
			background: var(--background);
			border-radius: 50%;
		}

		/* Text Input */
		.text-input {
			width: 100%;
			padding: 0.75rem 1rem;
			background: var(--secondary);
			border: 2px solid var(--border);
			border-radius: calc(var(--radius) - 4px);
			color: var(--foreground);
			font-family: 'Inter', sans-serif;
			font-size: 0.9rem;
			transition: all 0.3s;
		}

		.text-input:focus {
			outline: none;
			border-color: var(--primary);
			box-shadow: 0 0 15px hsla(var(--primary-hue), 100%, 50%, 0.3);
		}

		/* Separator */
		.separator {
			height: 1px;
			background: linear-gradient(90deg, transparent, var(--border), transparent);
			margin: 1.5rem 0;
		}

		/* ===== DEVELOPER CONSOLE COMMANDS ===== */
		.info-card {
			width: 100%;
			max-width: 500px;
			background: var(--card);
			border: 1px solid var(--primary);
			border-radius: var(--radius);
			padding: 1.25rem;
			margin-top: 1.5rem;
		}

		.info-card-title {
			font-size: 0.9rem;
			font-weight: 600;
			color: var(--primary);
			margin-bottom: 1rem;
			letter-spacing: 0.05em;
		}

		.command-item {
			margin-bottom: 0.75rem;
		}

		.command-item:last-child {
			margin-bottom: 0;
		}

		.command-name {
			color: var(--primary);
			font-weight: 500;
			font-size: 0.85rem;
		}

		.command-desc {
			color: var(--foreground);
			font-size: 0.8rem;
			opacity: 0.9;
		}

		.system-info-item {
			display: flex;
			gap: 0.5rem;
			margin-bottom: 0.5rem;
			font-size: 0.85rem;
		}

		.system-info-item:last-child {
			margin-bottom: 0;
		}

		.system-info-label {
			color: var(--primary);
			font-weight: 500;
		}

		.system-info-value {
			color: var(--foreground);
		}

		/* ===== PROGRESS BAR ===== */
		.progress-container {
			display: none;
			margin-bottom: 1.5rem;
		}

		.progress-container.visible {
			display: block;
		}

		.progress-label {
			display: flex;
			justify-content: space-between;
			font-size: 0.75rem;
			color: var(--muted);
			margin-bottom: 0.5rem;
		}

		.progress-bar {
			width: 100%;
			height: 24px;
			background: var(--secondary);
			border: 2px solid var(--border);
			border-radius: calc(var(--radius) - 4px);
			overflow: hidden;
			position: relative;
		}

		.progress-fill {
			height: 100%;
			background: linear-gradient(90deg, var(--primary-dark), var(--primary));
			width: 0%;
			transition: width 0.3s ease;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.progress-text {
			position: absolute;
			inset: 0;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 0.75rem;
			font-weight: 600;
			color: var(--foreground);
			text-shadow: 0 1px 2px rgba(0,0,0,0.5);
		}

		/* ===== LAUNCH BUTTON ===== */
		.launch-btn-wrapper {
			position: relative;
			display: inline-block;
		}

		/* Pulsing rings */
		.launch-btn-wrapper::before,
		.launch-btn-wrapper::after {
			content: '';
			position: absolute;
			inset: -8px;
			border-radius: calc(var(--radius) - 4px);
			border: 2px solid transparent;
			background: linear-gradient(90deg, 
				hsla(0, 100%, 50%, 0.5), 
				hsla(120, 100%, 50%, 0.5), 
				hsla(240, 100%, 50%, 0.5),
				hsla(0, 100%, 50%, 0.5)
			) border-box;
			-webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
			mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
			-webkit-mask-composite: xor;
			mask-composite: exclude;
			animation: pulse-ring-expand 2s ease-out infinite;
			pointer-events: none;
		}

		.launch-btn-wrapper::after {
			animation-delay: 1s;
		}

		@keyframes pulse-ring-expand {
			0% { inset: 0; opacity: 1; }
			100% { inset: -20px; opacity: 0; }
		}

		.launch-btn {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
			width: 100%;
			padding: 1rem 2rem;
			font-family: 'Orbitron', sans-serif;
			font-size: 1.1rem;
			font-weight: 600;
			letter-spacing: 0.05em;
			background: transparent;
			color: var(--primary);
			border-radius: calc(var(--radius) - 4px);
			cursor: pointer;
			transition: all 0.3s;
			animation: pulse-glow 2s ease-in-out infinite;
			/* Rainbow border */
			border: 3px solid transparent;
			background: 
				linear-gradient(var(--background), var(--background)) padding-box,
				linear-gradient(90deg, 
					hsl(0, 100%, 50%), 
					hsl(60, 100%, 50%), 
					hsl(120, 100%, 50%), 
					hsl(180, 100%, 50%), 
					hsl(240, 100%, 50%), 
					hsl(300, 100%, 50%), 
					hsl(360, 100%, 50%)
				) border-box;
			background-size: 100% 100%, 300% 100%;
			animation: rainbow-border-flow 3s linear infinite, pulse-glow 2s ease-in-out infinite;
		}

		@keyframes rainbow-border-flow {
			0% { background-position: 0% 0%, 0% 0%; }
			100% { background-position: 0% 0%, 300% 0%; }
		}

		.launch-btn:hover:not(:disabled) {
			background: 
				linear-gradient(var(--primary), var(--primary)) padding-box,
				linear-gradient(90deg, 
					hsl(0, 100%, 50%), 
					hsl(60, 100%, 50%), 
					hsl(120, 100%, 50%), 
					hsl(180, 100%, 50%), 
					hsl(240, 100%, 50%), 
					hsl(300, 100%, 50%), 
					hsl(360, 100%, 50%)
				) border-box;
			color: var(--background);
			transform: scale(1.05);
			box-shadow: 
				0 0 30px hsla(0, 100%, 50%, 0.3),
				0 0 50px hsla(120, 100%, 50%, 0.2),
				0 0 70px hsla(240, 100%, 50%, 0.1);
		}

		.launch-btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			animation: none;
		}

		@keyframes pulse-glow {
			0%, 100% { 
				box-shadow: 
					0 0 20px hsla(0, 100%, 60%, 0.4), 
					0 0 40px hsla(60, 100%, 50%, 0.3), 
					0 0 60px hsla(180, 100%, 50%, 0.2);
			}
			33% { 
				box-shadow: 
					0 0 20px hsla(120, 100%, 50%, 0.4), 
					0 0 40px hsla(180, 100%, 50%, 0.3), 
					0 0 60px hsla(240, 100%, 60%, 0.2);
			}
			66% { 
				box-shadow: 
					0 0 20px hsla(240, 100%, 60%, 0.4), 
					0 0 40px hsla(280, 100%, 60%, 0.3), 
					0 0 60px hsla(0, 100%, 60%, 0.2);
			}
		}

		/* Spinner */
		.spinner {
			width: 20px;
			height: 20px;
			border: 2px solid transparent;
			border-top-color: currentColor;
			border-radius: 50%;
			animation: spin 1s linear infinite;
			display: inline-block;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		/* ===== LOADER ===== */
		.loader-container {
			display: none;
			justify-content: center;
			margin-top: 2rem;
			position: relative;
			z-index: 1;
		}

		.loader-container.visible {
			display: flex;
		}

		/* Triple ring rainbow loader */
		.loader-rings {
			position: relative;
			width: 80px;
			height: 80px;
		}

		.loader-rings::before,
		.loader-rings::after,
		.loader-rings span {
			content: '';
			position: absolute;
			border-radius: 50%;
			border: 3px solid transparent;
		}

		.loader-rings::before {
			inset: 0;
			border-top-color: hsl(0, 100%, 60%);
			border-right-color: hsl(60, 100%, 60%);
			animation: spin 1.5s linear infinite;
		}

		.loader-rings::after {
			inset: 10px;
			border-top-color: hsl(120, 100%, 60%);
			border-right-color: hsl(180, 100%, 60%);
			animation: spin 1s linear infinite reverse;
		}

		.loader-rings span {
			inset: 20px;
			border-top-color: hsl(240, 100%, 60%);
			border-right-color: hsl(300, 100%, 60%);
			animation: spin 0.75s linear infinite;
		}

		/* ===== STATUS TEXT ===== */
		.status-section {
			margin-top: 1.5rem;
			text-align: center;
			min-height: 24px;
		}

		.status-text {
			font-size: 0.875rem;
			color: var(--muted);
		}

		.typewriter-cursor {
			animation: blink 1s step-end infinite;
			color: var(--primary);
		}

		@keyframes blink {
			50% { opacity: 0; }
		}

		/* ===== CANVAS (GAME) ===== */
		.game-canvas {
			display: none;
			width: 100%;
			height: 100vh;
			max-width: 100vw;
			max-height: 100vh;
			object-fit: contain;
			background-image: url(xd.png);
			border: none;
		}

		/* ===== CONTROLS (when game is running) ===== */
		.game-controls {
			display: none;
			position: fixed;
			top: 1rem;
			right: 1rem;
			z-index: 100;
			background: var(--card);
			padding: 1rem;
			border-radius: var(--radius);
			border: 1px solid var(--border);
		}

		.game-controls.visible {
			display: block;
		}

		.control-item {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			margin-bottom: 0.5rem;
			font-size: 0.8rem;
			color: var(--foreground);
		}

		.control-item:last-child {
			margin-bottom: 0;
		}

		.control-btn {
			padding: 0.5rem 1rem;
			background: var(--primary);
			border: none;
			border-radius: 4px;
			color: var(--background);
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s;
		}

		.control-btn:hover {
			box-shadow: 0 0 15px var(--primary);
		}

		/* ===== HIDDEN ELEMENTS ===== */
		.hidden {
			display: none !important;
		}

		#output {
			width: 100%;
			height: 200px;
			margin-top: 1rem;
			background: black;
			color: #00ff00;
			font-family: 'Lucida Console', Monaco, monospace;
			font-size: 0.75rem;
			padding: 0.5rem;
			border: 1px solid var(--border);
			border-radius: 4px;
			resize: none;
			display: none;
		}

		/* ===== FOOTER ===== */
		.footer {
			position: fixed;
			bottom: 1rem;
			text-align: center;
			width: 100%;
			z-index: 10;
		}

		.footer-text {
			font-size: 0.7rem;
			background: linear-gradient(90deg, 
				hsl(0, 100%, 70%), 
				hsl(60, 100%, 70%), 
				hsl(120, 100%, 70%), 
				hsl(180, 100%, 70%), 
				hsl(240, 100%, 70%), 
				hsl(300, 100%, 70%), 
				hsl(360, 100%, 70%)
			);
			background-size: 200% auto;
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
			animation: rainbow-shimmer 3s linear infinite;
		}
	</style>

	<script>
		// Prevent context menu
		document.addEventListener('contextmenu', event => event.preventDefault());
		
		// Warn before leaving
		window.onbeforeunload = function(e) {
			e.preventDefault();
			e.returnValue = 'Really want to quit the game?';
		};

		// Prevent Ctrl+S and Ctrl+W
		document.onkeydown = function(e) {
			e = e || window.event;
			if (!e.ctrlKey) return;
			var code = e.which || e.keyCode;
			switch (code) {
				case 83:
				case 87:
					e.preventDefault();
					e.stopPropagation();
					break;
			}
		};

		// Easter egg audio
		var a = new Audio('music.mp3');
		var pashalka_count = 0;

		function play_sound() {
			if (pashalka_count == 40) a.play();
			if (pashalka_count < 100) pashalka_count += 1;
		}
		window.addEventListener('click', play_sound);
		window.addEventListener('keydown', play_sound);
	</script>
</head>

<body>
	<!-- Rainbow Spiral Grid Canvas -->
	<canvas id="spiralCanvas"></canvas>

	<!-- Constellation Canvas -->
	<canvas id="constellationCanvas"></canvas>

	<!-- Color Picker -->
	<div class="color-picker">
		<button class="color-picker-btn" id="colorPickerBtn" onclick="toggleColorPicker()">
			<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
				<path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
			</svg>
		</button>
		<div class="color-picker-popup" id="colorPickerPopup">
			<div class="color-picker-section">
				<span class="color-picker-label">Primary Color</span>
				<div class="color-presets" id="primaryPresets"></div>
				<input type="range" class="color-slider" id="primarySlider" min="0" max="360" value="36">
			</div>
			<div class="color-picker-section">
				<span class="color-picker-label">Accent Color</span>
				<div class="color-presets" id="accentPresets"></div>
				<input type="range" class="color-slider" id="accentSlider" min="0" max="360" value="180">
			</div>
			<div class="color-preview">
				<div class="color-preview-box" id="primaryPreview">Primary</div>
				<div class="color-preview-box" id="accentPreview">Accent</div>
			</div>
		</div>
	</div>

	<!-- Game Canvas (hidden until launch) -->
	<canvas class="game-canvas" id="canvas" oncontextmenu="event.preventDefault()"></canvas>

	<!-- Game Controls (shown when game is running) -->
	<div class="game-controls" id="gameControls">
		<label class="control-item">
			<input type="checkbox" id="show_console_log"> Show Console Log
		</label>
		<label class="control-item">
			<input type="checkbox" id="resize"> Resize canvas
		</label>
		<label class="control-item">
			<input type="checkbox" id="pointerLock" checked> Lock/hide pointer
		</label>
		<button class="control-btn" onclick="Module.requestFullscreen(document.getElementById('pointerLock').checked, document.getElementById('resize').checked)">Fullscreen</button>
	</div>

	<!-- Main Container -->
	<div class="container" id="mainContainer">
		<!-- Title Section -->
		<div class="title-section">
			<h1 class="title">ProdByXander</h1>
			<h2 class="subtitle">Half-Life Web Version V4</h2>
		</div>

		<!-- Settings Card -->
		<div class="settings-card" id="settingsCard">
			<!-- Filesystem Selection -->
			<div class="form-section">
				<label class="form-label">
					<!-- Database icon -->
					<svg viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/></svg>
					Select filesystem for save and restore:
				</label>
				<span class="form-hint">(Default IndexedDB)</span>
				<div class="radio-group">
					<label class="radio-item" id="idbHider">
						<input type="radio" name="filesystem" id="rIndexedDB" checked>
						<!-- HardDrive icon -->
						<svg viewBox="0 0 24 24"><line x1="22" x2="2" y1="12" y2="12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><line x1="6" x2="6.01" y1="16" y2="16"/><line x1="10" x2="10.01" y1="16" y2="16"/></svg>
						<span>IndexedDB</span>
					</label>
					<label class="radio-item">
						<input type="radio" name="filesystem" id="rLocalStorage">
						<!-- Database icon -->
						<svg viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/></svg>
						<span>Local Storage</span>
					</label>
					<label class="radio-item">
						<input type="radio" name="filesystem" id="rNone">
						<!-- CPU icon -->
						<svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M15 2v2"/><path d="M15 20v2"/><path d="M2 15h2"/><path d="M2 9h2"/><path d="M20 15h2"/><path d="M20 9h2"/><path d="M9 2v2"/><path d="M9 20v2"/></svg>
						<span>RAM (Temporary)</span>
					</label>
				</div>
			</div>

			<div class="separator"></div>

			<!-- Version Selector (hidden by default, shown if multiple mods) -->
			<div class="form-section hidden" id="zipHider">
				<label class="form-label">Version Selector</label>
				<select class="text-input" id="selectZip"></select>
			</div>

			<!-- Command Line Arguments -->
			<div class="form-section">
				<label class="form-label" for="iArgs">
					<!-- Terminal icon -->
					<svg viewBox="0 0 24 24"><polyline points="4 17 10 11 4 5"/><line x1="12" x2="20" y1="19" y2="19"/></svg>
					Command-line arguments:
				</label>
				<input type="text" class="text-input" id="iArgs" value="-dev 0 -game valve" placeholder="-dev 0 -game valve">
			</div>

			<div class="separator"></div>

			<!-- Progress Bar -->
			<div class="progress-container" id="progressContainer">
				<div class="progress-label">
					<span id="statusText">Downloading...</span>
					<span id="progressPercent">0%</span>
				</div>
				<div class="progress-bar">
					<div class="progress-fill" id="progressFill"></div>
					<div class="progress-text" id="progressText">0%</div>
				</div>
			</div>

			<!-- Launch Button -->
			<div class="launch-btn-wrapper">
				<button class="launch-btn" id="launchBtn" onclick="startXash();">
					<span id="launchBtnText">Launch Half Life!</span>
				</button>
			</div>

			<!-- Loader -->
			<div class="loader-container" id="loaderContainer">
				<div class="loader-rings"><span></span></div>
			</div>
		</div>

		<!-- Developer Console Commands -->
		<div class="info-card">
			<h3 class="info-card-title">Developer Console Commands</h3>
			<div class="command-item">
				<span class="command-name">-dev 1 -game valve</span>
				<span class="command-desc"> Gives Access to console</span>
			</div>
			<div class="command-item">
				<span class="command-name">god</span>
				<span class="command-desc"> You must put this in the command bar in game using the ` key, to activate.</span>
			</div>
			<div class="command-item">
				<span class="command-name">impulse 101</span>
				<span class="command-desc"> You must put this in the command bar in game to spawn all weapons and get max ammo.</span>
			</div>
		</div>

		<!-- System Information -->
		<div class="info-card">
			<h3 class="info-card-title">System Information</h3>
			<div class="system-info-item">
				<span class="system-info-label">Engine:</span>
				<span class="system-info-value">Xash3D FWGS</span>
			</div>
			<div class="system-info-item">
				<span class="system-info-label">Memory:</span>
				<span class="system-info-value">2 GB RAM Allocated</span>
			</div>
			<div class="system-info-item">
				<span class="system-info-label">Status:</span>
				<span class="system-info-value" id="systemStatus">Ready to Launch</span>
			</div>
		</div>

		<!-- Status Section -->
		<div class="status-section">
			<p class="status-text" id="status"><span id="typewriterText"></span><span class="typewriter-cursor">|</span></p>
		</div>

		<!-- Console Output (hidden by default) -->
		<textarea id="output" rows="8" readonly></textarea>
	</div>

	<!-- Hidden Elements for Mods -->
	<div class="hidden">
		<div id="pkgHider"><select id="selectPkg"></select></div>
		<input type="file" id="iZipFile">
		<div id="asyncDialog"></div>
	</div>

	<!-- Footer -->
	<footer class="footer">
		<p class="footer-text">Engineered in the Black Mesa Research Facility by Xander</p>
	</footer>

	<!-- Rainbow Spiral Grid Animation -->
	<script>
		(function() {
			const canvas = document.getElementById('spiralCanvas');
			const ctx = canvas.getContext('2d');
			let animationId;
			let time = 0;

			function resize() {
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;
			}

			resize();
			window.addEventListener('resize', resize);

			const gridSize = 50;

			function animate() {
				time += 0.02;
				ctx.clearRect(0, 0, canvas.width, canvas.height);

				const centerX = canvas.width / 2;
				const centerY = canvas.height / 2;

				// Draw vertical lines
				for (let x = 0; x < canvas.width + gridSize; x += gridSize) {
					const distFromCenter = Math.abs(x - centerX);
					const hue = (time * 50 + distFromCenter * 0.5) % 360;
					const spiralOffset = Math.sin(time + distFromCenter * 0.01) * 20;
					
					ctx.beginPath();
					ctx.moveTo(x + spiralOffset, 0);
					
					for (let y = 0; y < canvas.height; y += 10) {
						const localSpiral = Math.sin(time * 2 + y * 0.01 + x * 0.005) * 15;
						ctx.lineTo(x + spiralOffset + localSpiral, y);
					}
					
					ctx.strokeStyle = `hsla(${hue}, 100%, 50%, 0.15)`;
					ctx.lineWidth = 1;
					ctx.stroke();
				}

				// Draw horizontal lines
				for (let y = 0; y < canvas.height + gridSize; y += gridSize) {
					const distFromCenter = Math.abs(y - centerY);
					const hue = (time * 50 + distFromCenter * 0.5 + 180) % 360;
					const spiralOffset = Math.cos(time + distFromCenter * 0.01) * 20;
					
					ctx.beginPath();
					ctx.moveTo(0, y + spiralOffset);
					
					for (let x = 0; x < canvas.width; x += 10) {
						const localSpiral = Math.cos(time * 2 + x * 0.01 + y * 0.005) * 15;
						ctx.lineTo(x, y + spiralOffset + localSpiral);
					}
					
					ctx.strokeStyle = `hsla(${hue}, 100%, 50%, 0.15)`;
					ctx.lineWidth = 1;
					ctx.stroke();
				}

				// Draw spiral from center
				for (let angle = 0; angle < Math.PI * 20; angle += 0.1) {
					const radius = angle * 15 + time * 30;
					const x = centerX + Math.cos(angle + time) * radius;
					const y = centerY + Math.sin(angle + time) * radius;
					const hue = (angle * 20 + time * 100) % 360;
					
					if (radius < Math.max(canvas.width, canvas.height)) {
						ctx.beginPath();
						ctx.arc(x, y, 1.5, 0, Math.PI * 2);
						ctx.fillStyle = `hsla(${hue}, 100%, 60%, 0.3)`;
						ctx.fill();
					}
				}

				animationId = requestAnimationFrame(animate);
			}

			animate();
		})();
	</script>

	<!-- Constellation Background with Mouse Interaction -->
	<script>
		(function() {
			const canvas = document.getElementById('constellationCanvas');
			const ctx = canvas.getContext('2d');
			const starCount = 60;
			const connectionDistance = 120;
			const mouseRadius = 150;
			const attractStrength = 0.02;
			const repelStrength = 0.05;
			
			let stars = [];
			let mouse = { x: -1000, y: -1000, active: false };

			function resize() {
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;
			}

			function createStars() {
				stars = [];
				for (let i = 0; i < starCount; i++) {
					stars.push({
						x: Math.random() * canvas.width,
						y: Math.random() * canvas.height,
						vx: (Math.random() - 0.5) * 0.5,
						vy: (Math.random() - 0.5) * 0.5,
						size: Math.random() * 2 + 1,
						hue: Math.random() * 360
					});
				}
			}

			resize();
			createStars();

			window.addEventListener('resize', () => {
				resize();
				createStars();
			});

			window.addEventListener('mousemove', (e) => {
				mouse.x = e.clientX;
				mouse.y = e.clientY;
				mouse.active = true;
			});

			window.addEventListener('mouseleave', () => {
				mouse.active = false;
			});

			function animate() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);

				// Draw mouse influence area
				if (mouse.active) {
					const gradient = ctx.createRadialGradient(
						mouse.x, mouse.y, 0,
						mouse.x, mouse.y, mouseRadius
					);
					gradient.addColorStop(0, 'hsla(280, 100%, 60%, 0.1)');
					gradient.addColorStop(1, 'hsla(280, 100%, 60%, 0)');
					ctx.beginPath();
					ctx.arc(mouse.x, mouse.y, mouseRadius, 0, Math.PI * 2);
					ctx.fillStyle = gradient;
					ctx.fill();
				}

				// Update and draw stars
				stars.forEach((star, i) => {
					// Mouse interaction
					if (mouse.active) {
						const dx = mouse.x - star.x;
						const dy = mouse.y - star.y;
						const distance = Math.sqrt(dx * dx + dy * dy);

						if (distance < mouseRadius && distance > 0) {
							const force = (mouseRadius - distance) / mouseRadius;
							const angle = Math.atan2(dy, dx);

							if (distance < 50) {
								// Repel when too close
								star.vx -= Math.cos(angle) * force * repelStrength;
								star.vy -= Math.sin(angle) * force * repelStrength;
							} else {
								// Attract when in range
								star.vx += Math.cos(angle) * force * attractStrength;
								star.vy += Math.sin(angle) * force * attractStrength;
							}

							star.hue = (star.hue + force * 5) % 360;
						}
					}

					// Apply friction
					star.vx *= 0.99;
					star.vy *= 0.99;

					// Clamp velocity
					const maxSpeed = 3;
					const speed = Math.sqrt(star.vx * star.vx + star.vy * star.vy);
					if (speed > maxSpeed) {
						star.vx = (star.vx / speed) * maxSpeed;
						star.vy = (star.vy / speed) * maxSpeed;
					}

					// Update position
					star.x += star.vx;
					star.y += star.vy;
					star.hue = (star.hue + 0.5) % 360;

					// Wrap around edges
					if (star.x < 0) star.x = canvas.width;
					if (star.x > canvas.width) star.x = 0;
					if (star.y < 0) star.y = canvas.height;
					if (star.y > canvas.height) star.y = 0;

					// Draw star with glow
					ctx.beginPath();
					ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
					ctx.fillStyle = `hsla(${star.hue}, 100%, 60%, 0.8)`;
					ctx.shadowBlur = 10;
					ctx.shadowColor = `hsla(${star.hue}, 100%, 60%, 0.5)`;
					ctx.fill();

					// Draw connection to mouse
					if (mouse.active) {
						const dx = mouse.x - star.x;
						const dy = mouse.y - star.y;
						const distance = Math.sqrt(dx * dx + dy * dy);

						if (distance < mouseRadius) {
							const opacity = (1 - distance / mouseRadius) * 0.4;
							ctx.beginPath();
							ctx.moveTo(star.x, star.y);
							ctx.lineTo(mouse.x, mouse.y);
							ctx.strokeStyle = `hsla(${star.hue}, 100%, 70%, ${opacity})`;
							ctx.lineWidth = 0.5;
							ctx.stroke();
						}
					}

					// Draw connections to nearby stars
					for (let j = i + 1; j < stars.length; j++) {
						const other = stars[j];
						const dx = star.x - other.x;
						const dy = star.y - other.y;
						const distance = Math.sqrt(dx * dx + dy * dy);

						if (distance < connectionDistance) {
							const opacity = (1 - distance / connectionDistance) * 0.3;
							const gradient = ctx.createLinearGradient(star.x, star.y, other.x, other.y);
							gradient.addColorStop(0, `hsla(${star.hue}, 100%, 60%, ${opacity})`);
							gradient.addColorStop(1, `hsla(${other.hue}, 100%, 60%, ${opacity})`);
							
							ctx.beginPath();
							ctx.moveTo(star.x, star.y);
							ctx.lineTo(other.x, other.y);
							ctx.strokeStyle = gradient;
							ctx.lineWidth = 0.5;
							ctx.stroke();
						}
					}
				});

				ctx.shadowBlur = 0;
				requestAnimationFrame(animate);
			}

			animate();
		})();
	</script>

	<!-- Color Picker Logic -->
	<script>
		const presetColors = [
			{ name: 'White', hue: 0, isNeutral: true, lightness: 100 },
			{ name: 'Black', hue: 0, isNeutral: true, lightness: 10 },
			{ name: 'Red', hue: 0 },
			{ name: 'Orange', hue: 36 },
			{ name: 'Yellow', hue: 60 },
			{ name: 'Green', hue: 120 },
			{ name: 'Cyan', hue: 180 },
			{ name: 'Blue', hue: 220 },
			{ name: 'Purple', hue: 280 },
			{ name: 'Pink', hue: 320 }
		];

		let primaryHue = 0; // White default
		let accentHue = 0; // White default

		function updateTheme() {
			document.documentElement.style.setProperty('--primary-hue', primaryHue);
			document.documentElement.style.setProperty('--accent-hue', accentHue);
			document.documentElement.style.setProperty('--primary', `hsl(${primaryHue}, 100%, 50%)`);
			document.documentElement.style.setProperty('--primary-dark', `hsl(${primaryHue}, 100%, 35%)`);
			document.documentElement.style.setProperty('--accent', `hsl(${accentHue}, 100%, 50%)`);
			
			document.getElementById('primaryPreview').style.background = `hsl(${primaryHue}, 100%, 50%)`;
			document.getElementById('primaryPreview').style.color = primaryHue > 40 && primaryHue < 200 ? '#000' : '#fff';
			document.getElementById('accentPreview').style.background = `hsl(${accentHue}, 100%, 50%)`;
			document.getElementById('accentPreview').style.color = accentHue > 40 && accentHue < 200 ? '#000' : '#fff';
		}

		function createPresets() {
			const primaryContainer = document.getElementById('primaryPresets');
			const accentContainer = document.getElementById('accentPresets');
			
			presetColors.forEach(color => {
				const primaryBtn = document.createElement('button');
				primaryBtn.className = 'color-preset';
				primaryBtn.style.background = color.isNeutral 
					? `hsl(0, 0%, ${color.lightness}%)` 
					: `hsl(${color.hue}, 100%, 50%)`;
				primaryBtn.onclick = () => {
					primaryHue = color.hue;
					document.getElementById('primarySlider').value = color.hue;
					updateTheme();
				};
				primaryContainer.appendChild(primaryBtn);
				
				const accentBtn = document.createElement('button');
				accentBtn.className = 'color-preset';
				accentBtn.style.background = color.isNeutral 
					? `hsl(0, 0%, ${color.lightness}%)` 
					: `hsl(${color.hue}, 100%, 50%)`;
				accentBtn.onclick = () => {
					accentHue = color.hue;
					document.getElementById('accentSlider').value = color.hue;
					updateTheme();
				};
				accentContainer.appendChild(accentBtn);
			});
		}

		function toggleColorPicker() {
			const popup = document.getElementById('colorPickerPopup');
			popup.classList.toggle('visible');
		}

		document.getElementById('primarySlider').addEventListener('input', (e) => {
			primaryHue = parseInt(e.target.value);
			updateTheme();
		});

		document.getElementById('accentSlider').addEventListener('input', (e) => {
			accentHue = parseInt(e.target.value);
			updateTheme();
		});

		createPresets();
		updateTheme();
	</script>

	<!-- Typewriter Effect -->
	<script>
		(function() {
			const idleMessages = [
				"Ready to enter Ku Klux Klan?",
				"Welcome to the KKK!",
				"Fuck tech, this sites unblockable lmao",
				"Im bored idk what im putting here",
				"Gordon Freeman is a fucking pedophile, he fucks the headcrabs!",
				"Game is ready to launch!",
				"Heil hitler!"
			];

			const loadingMessages = [
				"Initializing Reactor systems...",
				"Loading valve game assets...",
				"Downloading & Inserting Textures...",
				"Fucking around with the flux capacitor...",
				"Connecting to Ku Klux Klan's public wifi...",
				"Finishing loading particles lmao..."
			];

			let currentMessages = idleMessages;
			let messageIndex = 0;
			let charIndex = 0;
			let isDeleting = false;
			let isPaused = false;
			let isLoading = false;

			const typewriterEl = document.getElementById('typewriterText');
			const typingSpeed = 60;
			const deletingSpeed = 30;
			const pauseDuration = 2500;

			function type() {
				const currentMessage = currentMessages[messageIndex];

				if (isPaused) {
					setTimeout(() => {
						isPaused = false;
						isDeleting = true;
						type();
					}, pauseDuration);
					return;
				}

				if (isDeleting) {
					if (charIndex > 0) {
						charIndex--;
						typewriterEl.textContent = currentMessage.substring(0, charIndex);
						setTimeout(type, deletingSpeed);
					} else {
						isDeleting = false;
						messageIndex = (messageIndex + 1) % currentMessages.length;
						setTimeout(type, typingSpeed);
					}
					return;
				}

				if (charIndex < currentMessage.length) {
					charIndex++;
					typewriterEl.textContent = currentMessage.substring(0, charIndex);
					setTimeout(type, typingSpeed);
				} else {
					isPaused = true;
					setTimeout(type, 100);
				}
			}

			// Start typing
			type();

			// Expose function to switch to loading messages
			window.setTypewriterLoading = function(loading) {
				if (loading !== isLoading) {
					isLoading = loading;
					currentMessages = loading ? loadingMessages : idleMessages;
					messageIndex = 0;
					charIndex = 0;
					isDeleting = false;
					isPaused = false;
					typewriterEl.textContent = '';
					typewriterEl.style.color = loading ? 'var(--primary)' : 'var(--muted)';
				}
			};
		})();
	</script>

	<!-- BrowserFS -->
	<script type='text/javascript' src='browserfs.min.js'></script>
	
	<script type='text/javascript'>
		var zipMods = [];
		var pkgMods = [];
	</script>

	<!-- Mods Configuration -->
	<script type='text/javascript' src='mods.js'></script>

	<script type='text/javascript'>
		var show_again = true;
		var statusElement = document.getElementById('status');
		var progressElement = document.getElementById('progressFill');
		var progressText = document.getElementById('progressText');
		var progressPercent = document.getElementById('progressPercent');
		var progressContainer = document.getElementById('progressContainer');
		var asyncDialog = document.getElementById('asyncDialog');
		var myerrorbuf = '';
		var myerrordate = new Date();
		var mounted = false;
		var gamedir = 'valve';
		var moduleCount = 0;
		var mfs;
		var zipSize;

		// Polyfill for older browsers
		if (!ArrayBuffer['isView']) {
			ArrayBuffer.isView = function(a) {
				return a !== null && typeof(a) === "object" && a['buffer'] instanceof ArrayBuffer;
			};
		}

		function updateProgress(percent) {
			progressElement.style.width = percent + '%';
			progressText.textContent = percent + '%';
			progressPercent.textContent = percent + '%';
		}

		function prepareSelects() {
			var len = zipMods.length;
			var select = document.getElementById('selectZip');
			if (len) {
				showElement('zipHider', true);
				if (len > 1) {
					for (var i = 0; i < len; i++) {
						select.options[i] = new Option(zipMods[i][1], zipMods[i][0]);
					}
				}
			} else {
				document.getElementById('rZip') && (document.getElementById('rZip').checked = false);
			}
			
			len = pkgMods.length;
			select = document.getElementById('selectPkg');
			if (len) {
				showElement('pkgHider', true);
				if (len > 1) {
					for (var i = 0; i < len; i++) {
						select.options[i] = new Option(pkgMods[i][1], pkgMods[i][0]);
					}
				}
			} else {
				document.getElementById('rPackage') && (document.getElementById('rPackage').checked = false);
			}
		}

		var Module = {
			TOTAL_MEMORY: 150 * 1024 * 1024,
			preRun: [],
			postRun: [],
			print: (function() {
				var element = document.getElementById('output');
				if (element) element.value = '';
				return function(text) {
					if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
					if (text) {
						myerrorbuf += text + '\n';
						console.log(text);
						if (text == "exit(0)") {
							document.getElementById('canvas').style.display = "none";
							document.getElementById('mainContainer').style.display = "flex";
							document.getElementById('gameControls').classList.remove('visible');
							setTimeout(function(){
								location.reload();
							}, 1000);
						} else if (text == "shader success") {
							pashalka_count = 100;
							a.pause();
							document.getElementById('canvas').style.display = "block";
							document.getElementById('gameControls').classList.add('visible');
						}
					}
					if (element) {
						if (element.value.length > 65536)
							element.value = element.value.substring(512) + myerrorbuf;
						else
							element.value += myerrorbuf;
						element.scrollTop = element.scrollHeight;
					}
					myerrorbuf = '';
				};
			})(),
			printErr: function(text) {
				if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
				if (myerrorbuf.length > 2048)
					myerrorbuf = 'some lines skipped\n' + myerrorbuf.substring(512);
				myerrorbuf += text + '\n';
				if (new Date() - myerrordate > 3000) {
					myerrordate = new Date();
					Module.print();
				}
			},
			canvas: (function() {
				var canvas = document.getElementById('canvas');
				canvas.addEventListener("webglcontextlost", function(e) {
					alert('WebGL context lost. You will need to reload the page.');
					e.preventDefault();
				}, false);
				return canvas;
			})(),
			setStatus: function(text) {
				if (!Module.setStatus.last) Module.setStatus.last = {
					time: Date.now(),
					text: ''
				};
				if (text === Module.setStatus.text) return;
				if (new Date() - myerrordate > 3000) {
					myerrordate = new Date();
					Module.print();
				}

				statusElement.innerHTML = text;
				document.getElementById('statusText').textContent = text;
				
				var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
				if (m) {
					var progress = Math.round(parseInt(m[2]) * 100 / parseInt(m[4]));
					updateProgress(progress);
					progressContainer.classList.add('visible');
				}
			},
			totalDependencies: 0,
			monitorRunDependencies: function(left) {
				this.totalDependencies = Math.max(this.totalDependencies, left);
				if (left)
					Module.setStatus('Preparing... (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')');
			}
		};

		window.onerror = function(event) {
			if (mounted)
				FS.syncfs(false, function(err) {
					Module.print('Saving IDBFS: ' + err);
				});
			if (('' + event).indexOf('SimulateInfiniteLoop') > 0)
				return;
			var text = 'Exception thrown: ' + event;
			text = text.replace(/&/g, "&amp;");
			text = text.replace(/</g, "&lt;");
			text = text.replace(/>/g, "&gt;");
			text = text.replace('\n', '<br>', 'g');
			Module.setStatus(text);
			Module.print('Exception thrown: ' + event);
		};

		function haltRun() {}

		var savedRun;

		function radioChecked(id) {
			var r = document.getElementById('r' + id);
			if (r) return r.checked;
			return false;
		}

		function showElement(id, show) {
			var e = document.getElementById(id);
			if (!e) return;
			if (show) {
				e.classList.remove('hidden');
			} else {
				e.classList.add('hidden');
			}
		}

		Module.setStatus('Downloading...');

		function startXash() {
			var btn = document.getElementById('launchBtn');
			var btnText = document.getElementById('launchBtnText');
			
			btn.disabled = true;
			btnText.innerHTML = '<span class="spinner"></span> Loading...';
			
			// Switch typewriter to loading messages
			if (window.setTypewriterLoading) {
				window.setTypewriterLoading(true);
			}
			
			document.getElementById('systemStatus').textContent = 'Loading...';
			progressContainer.classList.add('visible');
			document.getElementById('loaderContainer').classList.add('visible');
			document.getElementById('mainContainer').style.display = 'none';
			document.getElementById('canvas').style.display = 'block';
			
			setupFS();
			Module.arguments = document.getElementById('iArgs').value.split(' ');
			Module.run = run = savedRun;
			
			if (radioChecked('Zip') || zipMods.length > 0) {
				const zipper = document.getElementById('selectZip');
				if (zipMods.length > 1) {
					var mod_parts = [zipMods[0][3], zipMods[0][4], zipMods[0][2]];
					for (var i = 0; i < zipMods.length; i++) {
						if (zipMods[i][0] == zipper.value) {
							mod_parts = [zipMods[i][3], zipMods[i][4], zipMods[i][2]];
							break;
						}
					}
					fetchZIP(zipper.value, savedRun, mod_parts[0], mod_parts[1], mod_parts[2]);
				} else if (zipMods.length === 1) {
					fetchZIP(zipMods[0][0], savedRun, zipMods[0][3]);
				}
			} else if (radioChecked('LocalZip')) {
				var reader = new FileReader();
				reader.onload = function() {
					mountZIP(reader.result);
					Module.print("Loaded zip data");
					savedRun();
				};
				reader.readAsArrayBuffer(document.getElementById('iZipFile').files[0]);
			} else if (radioChecked('Package')) {
				var script = document.createElement('script');
				script.onload = savedRun;
				document.body.appendChild(script);
				script.src = pkgMods.length > 1 ? document.getElementById('selectPkg').value : pkgMods[0][0];
			}

			window.addEventListener("beforeunload", function(e) {
				var confirmationMessage = 'Leave the game?';
				(e || window.event).returnValue = confirmationMessage;
				return confirmationMessage;
			});
		}

		function mountZIP(data) {
			var Buffer = BrowserFS.BFSRequire('buffer').Buffer;
			mfs.mount('/zip', new BrowserFS.FileSystem.ZipFS(Buffer.from(data)));
			FS.mount(new BrowserFS.EmscriptenFS(), {
				root: '/zip'
			}, '/rodir');
		}

		function fetchZIP(packageName, cb, parts = 0, size_of_parts = 0, total_size = 0) {
			if (parts == 0) {
				var xhr = new XMLHttpRequest();
				xhr.open('GET', packageName, true);
				xhr.responseType = 'arraybuffer';

				xhr.onprogress = function(event) {
					var size;
					if (event.total) size = event.total;
					else size = zipMods[document.getElementById('selectZip').selectedIndex] ? zipMods[document.getElementById('selectZip').selectedIndex][2] : event.loaded;
					if (event.loaded && size) {
						var progress = Math.round(event.loaded * 100 / size);
						updateProgress(progress);
						Module.setStatus('Downloading data... (' + event.loaded + '/' + size + ')');
					}
				};
				xhr.onerror = function(event) {
					throw new Error("NetworkError");
				};
				xhr.onload = function(event) {
					if (xhr.status == 200 || xhr.status == 304 || xhr.status == 206 || (xhr.status == 0 && xhr.response)) {
						updateProgress(100);
						mountZIP(xhr.response);
						cb();
					} else {
						throw new Error(xhr.statusText + " : " + xhr.responseURL);
					}
				};
				xhr.send(null);
			} else {
				var buffers = new Uint8Array(total_size);
				var finished = 0;
				for (var i = 0; i < parts; i++) {
					const cur = i;
					const no_ext = packageName.slice(0, -4);
					const url1 = no_ext + '_out/' + no_ext + '-' + cur + '.zip';
					console.log(url1);
					const xhr = new XMLHttpRequest();
					xhr.open('GET', url1, true);
					xhr.responseType = 'arraybuffer';

					xhr.onprogress = function(event) {
						if (event.loaded) {
							var loaded = event.loaded;
							var totalLoaded = (finished * size_of_parts) + loaded;
							var progress = Math.round(totalLoaded * 100 / total_size);
							updateProgress(progress);
							Module.setStatus('Downloading data... (' + totalLoaded + '/' + total_size + ')');
						}
					};
					xhr.onerror = function(event) {
						throw new Error("NetworkError");
					};
					xhr.onload = function(event) {
						if (xhr.status == 200 || xhr.status == 304 || xhr.status == 206 || (xhr.status == 0 && xhr.response)) {
							finished++;
							buffers.set(new Uint8Array(xhr.response), cur * size_of_parts);
							if (finished == parts) {
								updateProgress(100);
								mountZIP(buffers);
								cb();
							}
						} else {
							throw new Error(xhr.statusText + " : " + xhr.responseURL);
						}
					};
					xhr.send(null);
				}
			}
		}

		function setupFS() {
			FS.mkdir('/rodir');
			FS.mkdir('/xash');
			try {
				mfs = new BrowserFS.FileSystem.MountableFileSystem();
				BrowserFS.initialize(mfs);
			} catch (e) {
				mfs = undefined;
				Module.print('Failed to initialize BrowserFS: ' + e);
			}

			if (radioChecked('IndexedDB')) {
				FS.mount(IDBFS, {}, '/xash');
				FS.syncfs(true, function(err) {
					if (err) Module.print('Loading IDBFS: ' + err);
				});
				mounted = true;
			}

			if (radioChecked('LocalStorage') && mfs) {
				mfs.mount('/ls', new BrowserFS.FileSystem.LocalStorage());
				FS.mount(new BrowserFS.EmscriptenFS(), {
					root: '/ls'
				}, '/xash');
				Module.print('LocalStorage mounted');
			}

			FS.chdir('/xash/');
		}

		function skipRun() {
			savedRun = run;
			Module.run = haltRun;
			run = haltRun;

			Module.setStatus("Game is ready to start!");
			document.getElementById('systemStatus').textContent = 'Ready to Launch';
			document.getElementById('loaderContainer').classList.remove('visible');

			if (window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB)
				showElement('idbHider', true);
			prepareSelects();

			ENV.XASH3D_GAMEDIR = gamedir;
			ENV.XASH3D_RODIR = '/rodir';

			function loadModule(name) {
				var script = document.createElement('script');
				script.onload = function() {
					moduleCount++;
					if (moduleCount == 3) {
						Module.setStatus("Game is ready to start and is downloaded!");
						progressContainer.classList.remove('visible');
					}
				};
				document.body.appendChild(script);
				script.src = name + ".js";
			}

			loadModule("server");
			loadModule("client");
			loadModule("menu");
		}

		Module.preInit = [skipRun];
		Module.websocket = [];
		Module.websocket.url = 'wsproxy://4.tcp.ngrok.io:10657/';
		ENV = [];
	</script>

	<script>
		(function() {
			var memoryInitializer = 'xash.html.mem';
			if (typeof Module['locateFile'] === 'function') {
				memoryInitializer = Module['locateFile'](memoryInitializer);
			} else if (Module['memoryInitializerPrefixURL']) {
				memoryInitializer = Module['memoryInitializerPrefixURL'] + memoryInitializer;
			}
			var xhr = Module['memoryInitializerRequest'] = new XMLHttpRequest();
			xhr.open('GET', memoryInitializer, true);
			xhr.responseType = 'arraybuffer';
			xhr.send(null);
		})();

		var script = document.createElement('script');
		script.src = "xash.js";
		document.body.appendChild(script);
	</script>

	<script>
		document.getElementById('show_console_log').addEventListener('change', function() {
			if (document.getElementById('show_console_log').checked) {
				document.getElementById('output').style.display = "block";
			} else {
				document.getElementById('output').style.display = "none";
			}
		});
	</script>
</body>
</html>


